<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foie Gras Restaurant Analysis</title>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="/static/style.css" />
    <style>
      /* Additional styles for insights-first layout */
      .study-context {
        background: linear-gradient(135deg, #2d5a4a 0%, #1a3d32 100%);
        color: white;
        padding: 2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
      }
      .study-context h2 {
        color: white;
        margin-bottom: 1rem;
        font-size: 1.5rem;
      }
      .context-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1.5rem;
      }
      .context-item {
        text-align: center;
      }
      .context-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #c9a957;
      }
      .context-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }
      
      .insight-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        border-left: 5px solid #c9a957;
      }
      .insight-card h3 {
        color: #2d5a4a;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
      }
      .insight-text {
        font-size: 1.25rem;
        color: #1a1a2e;
        margin-bottom: 1rem;
        line-height: 1.5;
      }
      .insight-text .highlight {
        color: #c9a957;
        font-weight: 600;
      }
      .insight-supporting {
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        color: #4a5568;
      }
      
      .sample-items-section {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }
      .sample-items-section h2 {
        color: #2d5a4a;
        margin-bottom: 1rem;
      }
      .sample-items-table {
        width: 100%;
        border-collapse: collapse;
      }
      .sample-items-table th,
      .sample-items-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }
      .sample-items-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #2d5a4a;
      }
      .sample-items-table tr:hover {
        background: #f8f9fa;
      }
      .item-title {
        font-weight: 500;
        color: #1a1a2e;
      }
      .item-description {
        font-size: 0.85rem;
        color: #718096;
        max-width: 300px;
      }
      .item-price {
        font-weight: 600;
        color: #c9a957;
      }
      
      .chart-section {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }
      .chart-section h2 {
        color: #2d5a4a;
        margin-bottom: 0.5rem;
      }
      .chart-context {
        font-size: 0.9rem;
        color: #718096;
        margin-bottom: 1rem;
      }
      
      .insights-section {
        margin-bottom: 2rem;
      }
      
      .policy-note {
        background: #fff8e6;
        border: 1px solid #c9a957;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        font-size: 0.9rem;
      }
      .policy-note strong {
        color: #2d5a4a;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <h1>Foie Gras in American Restaurants</h1>
        </div>
        <p class="subtitle">An Analysis to Inform Policy Decisions</p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      
      <!-- Study Context (moved to top per feedback) - with card boxes and icons -->
      <section class="hero-stats" style="margin-bottom: 2rem;">
        <div class="stat-card">
          <div class="stat-icon">üçΩÔ∏è</div>
          <div class="stat-value">{{ stats.total_restaurants }}</div>
          <div class="stat-label">Restaurants Analyzed</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìã</div>
          <div class="stat-value">{{ "{:,}".format(stats.total_menu_items) }}</div>
          <div class="stat-label">Menu Items Collected</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üèôÔ∏è</div>
          <div class="stat-value">30</div>
          <div class="stat-label">Cities Across 10 States + DC</div>
        </div>
        <div class="stat-card highlight">
          <div class="stat-icon"><img src="/static/goose-icon.png" alt="Goose" class="stat-icon-img"></div>
          <div class="stat-value">{{ stats.total_foie_gras_items }}</div>
          <div class="stat-label">Foie Gras Items Found</div>
        </div>
      </section>
      
      <div style="background: #f8f9fa; padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 2rem; border-left: 4px solid #2d5a4a;">
        <p style="margin: 0; color: #4a5568; font-size: 0.95rem;">
          <strong style="color: #2d5a4a;">About This Study:</strong> Data collected from OpenTable restaurant menus in January 2026. This study covers states where foie gras sales are currently legal to understand the potential impact of proposed bans.
        </p>
      </div>

      <!-- Key Insights Section -->
      <section class="insights-section">
        <h2 style="color: #2d5a4a; margin-bottom: 1rem;">Key Findings</h2>
        
        <!-- Insight 1: Prevalence -->
        <div class="insight-card">
          <h3>üìä Foie Gras Prevalence</h3>
          <p class="insight-text">
            <span class="highlight" id="insight-pct">--</span> of restaurants have foie gras on their menu, representing 
            <span class="highlight">{{ stats.restaurants_with_foie }}</span> restaurants in our sample.
          </p>
          <div class="insight-supporting">
            <strong>What this means:</strong> A potential ban would directly impact these restaurants, requiring menu changes and potentially affecting their positioning as upscale dining establishments.
          </div>
        </div>
        
        <!-- Insight 2: European Cuisine Dominance -->
        <div class="insight-card">
          <h3>üçΩÔ∏è European Cuisine Dominance</h3>
          <p class="insight-text" id="european-insight">
            Loading European cuisine analysis...
          </p>
          <div class="insight-supporting">
            <strong>Implication:</strong> French, Italian, and European restaurants would be disproportionately affected by a ban, as foie gras is a traditional component of these cuisines.
          </div>
        </div>
        
        <!-- Insight 3: Premium Positioning -->
        <div class="insight-card">
          <h3>üí∞ Premium Menu Item Pricing</h3>
          <p class="insight-text">
            Foie gras menu items are priced at <span class="highlight" id="insight-premium">--</span> more than the median menu item price 
            (<span id="insight-foie-price">$--</span> vs <span id="insight-median-price">$--</span>).
          </p>
          <div class="insight-supporting">
            <strong>Menu item price range:</strong> <span id="insight-price-range">$-- - $--</span> for foie gras dishes. This premium pricing suggests foie gras serves as a signature or high-margin menu item for many restaurants.
          </div>
        </div>
        
        <!-- Insight 4: Multiple Offerings -->
        <div class="insight-card">
          <h3>üìã Multiple Preparations</h3>
          <p class="insight-text">
            Restaurants average <span class="highlight">{{ stats.avg_foie_per_restaurant or '1.6' }}</span> foie gras items each. 
            <span class="highlight">{{ stats.multi_offering_pct or '--' }}%</span> of restaurants with foie gras offer more than one preparation.
          </p>
          <div class="insight-supporting">
            <strong>What this means:</strong> Many restaurants have invested in multiple foie gras offerings, suggesting it's a core part of their culinary identity rather than a single novelty item.
          </div>
        </div>
        
        <!-- Insight 5: Upscale Focus -->
        <div class="insight-card">
          <h3>‚≠ê Upscale Restaurant Focus</h3>
          <p class="insight-text" id="price-tier-insight">
            Loading price tier analysis...
          </p>
          <div class="insight-supporting">
            <strong>Context:</strong> OpenTable categorizes restaurants by average entr√©e price: "$30 and under", "$31 to $50", and "$50 and over".
          </div>
        </div>
      </section>

      <!-- All Foie Gras Menu Items - Comprehensive Table -->
      <section class="sample-items-section">
        <h2>Complete Foie Gras Menu Items</h2>
        <p class="chart-context">All {{ stats.total_foie_gras_items }} foie gras menu items found across {{ stats.restaurants_with_foie }} restaurants, sorted by state. Prices shown are individual menu item prices.</p>
        <div style="max-height: 500px; overflow-y: auto;">
          <table class="sample-items-table">
            <thead style="position: sticky; top: 0; background: white; z-index: 10;">
              <tr>
                <th>Restaurant</th>
                <th>Location</th>
                <th>Menu Item</th>
                <th>Description</th>
                <th>Price</th>
              </tr>
            </thead>
            <tbody id="all-foie-items-body">
              <tr><td colspan="5">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Charts Row: State Analysis -->
      <div class="charts-row">
        <section class="chart-section">
          <h2>Foie Gras Prevalence by State</h2>
          <p class="chart-context">Comparing restaurant counts (bars) with foie gras prevalence rate (line). The percentage shows what proportion of restaurants in each state offer foie gras.</p>
          <canvas id="stateChart"></canvas>
        </section>
      </div>
      
      <!-- Charts Row: Price Analysis -->
      <div class="charts-row">
        <section class="chart-section">
          <h2>Foie Gras Price Distribution</h2>
          <p class="chart-context">Distribution of foie gras menu item prices across all restaurants.</p>
          <canvas id="priceDistChart"></canvas>
        </section>
        
        <section class="chart-section">
          <h2>Foie Gras by Restaurant Price Tier</h2>
          <p class="chart-context">Percentage of restaurants offering foie gras, grouped by OpenTable price tier (based on average entr√©e price).</p>
          <canvas id="priceTierChart"></canvas>
        </section>
      </div>
      
      <!-- Charts Row: Cuisine & Menu Section -->
      <div class="charts-row">
        <section class="chart-section">
          <h2>Foie Gras Prevalence by Restaurant Type</h2>
          <p class="chart-context">Number of restaurants serving foie gras by primary cuisine type, sorted by prevalence.</p>
          <canvas id="cuisineChart"></canvas>
        </section>
        
        <section class="chart-section">
          <h2>Menu Placement</h2>
          <p class="chart-context">Where foie gras appears on restaurant menus.</p>
          <canvas id="sectionChart"></canvas>
        </section>
      </div>

    </main>

    <!-- Footer -->
    <footer class="footer">
      <p>Foie Gras Restaurant Analysis ‚Ä¢ Data collected January 2026 ‚Ä¢ Study covers states where foie gras is legal</p>
    </footer>

    <script>
      // Load stats for insights
      fetch("/api/stats")
        .then((res) => res.json())
        .then((stats) => {
          // Prevalence percentage
          const pct = ((stats.restaurants_with_foie / stats.total_restaurants) * 100).toFixed(1);
          document.getElementById("insight-pct").textContent = pct + "%";
          
          // Price premium
          if (stats.foie_price_premium_pct !== null) {
            const prefix = stats.foie_price_premium_pct >= 0 ? '+' : '';
            document.getElementById("insight-premium").textContent = prefix + stats.foie_price_premium_pct + "%";
            document.getElementById("insight-foie-price").textContent = "$" + stats.median_foie_price;
            document.getElementById("insight-median-price").textContent = "$" + stats.median_food_price;
          }
          
          // Price range
          if (stats.min_foie_price && stats.max_foie_price) {
            document.getElementById("insight-price-range").textContent = 
              "$" + stats.min_foie_price + " - $" + stats.max_foie_price;
          }
        });
      
      // Load European insight
      fetch("/api/european-insight")
        .then((res) => res.json())
        .then((data) => {
          const multiplier = (data.foie_pct / data.total_pct).toFixed(1);
          document.getElementById("european-insight").innerHTML = `
            European-style restaurants (French, Italian, Mediterranean) make up 
            <span class="highlight">${data.foie_pct}%</span> of restaurants serving foie gras, 
            but only <span class="highlight">${data.total_pct}%</span> of all restaurants sampled ‚Äî 
            a <span class="highlight">${multiplier}x</span> over-representation.
          `;
        });
      
      // Load price tier data for insight
      fetch("/api/price-tier-foie")
        .then((res) => res.json())
        .then((tiers) => {
          const upscale = tiers['$50 and over'];
          const budget = tiers['$30 and under'];
          if (upscale && budget) {
            const multiplier = (upscale.rate / budget.rate).toFixed(1);
            document.getElementById("price-tier-insight").innerHTML = `
              <span class="highlight">${upscale.rate}%</span> of upscale restaurants ($50+ entr√©es) offer foie gras, 
              compared to just <span class="highlight">${budget.rate}%</span> of budget-friendly restaurants ‚Äî 
              a <span class="highlight">${multiplier}x</span> difference.
            `;
          }
        });
      
      // Load all foie gras menu items (comprehensive table)
      fetch("/api/all-foie-items")
        .then((res) => res.json())
        .then((items) => {
          const tbody = document.getElementById("all-foie-items-body");
          if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">No items found</td></tr>';
            return;
          }
          tbody.innerHTML = items.map(item => `
            <tr>
              <td class="item-title">${item.restaurant}</td>
              <td>${item.city}, ${item.state}</td>
              <td style="font-weight: 500;">${item.item_name}</td>
              <td class="item-description">${item.description || '‚Äî'}</td>
              <td class="item-price">${item.price ? '$' + item.price.toFixed(0) : '‚Äî'}</td>
            </tr>
          `).join('');
        });

      // Load state data for combined chart
      fetch("/api/states")
        .then((res) => res.json())
        .then((states) => {
          // Sort by restaurant count for display
          states = states.sort((a, b) => b.restaurant_count - a.restaurant_count);
          
          new Chart(document.getElementById("stateChart"), {
            type: "bar",
            data: {
              labels: states.map((s) => s.state_name),
              datasets: [
                {
                  label: "Restaurants",
                  data: states.map((s) => s.restaurant_count),
                  backgroundColor: "rgba(201, 169, 87, 0.7)",
                  borderColor: "rgba(201, 169, 87, 1)",
                  borderWidth: 1,
                  yAxisID: 'y',
                },
                {
                  label: "Foie Gras Rate (%)",
                  data: states.map((s) => s.foie_rate),
                  type: 'line',
                  borderColor: "#2d5a4a",
                  backgroundColor: "#2d5a4a",
                  borderWidth: 3,
                  pointRadius: 6,
                  pointBackgroundColor: "#2d5a4a",
                  yAxisID: 'y1',
                },
              ],
            },
            options: {
              responsive: true,
              interaction: {
                mode: 'index',
                intersect: false,
              },
              plugins: {
                legend: { 
                  display: true,
                  position: 'top',
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      if (context.dataset.label === 'Foie Gras Rate (%)') {
                        return context.dataset.label + ': ' + context.raw + '%';
                      }
                      return context.dataset.label + ': ' + context.raw;
                    }
                  }
                }
              },
              scales: {
                y: {
                  type: 'linear',
                  display: true,
                  position: 'left',
                  beginAtZero: true,
                  title: {
                    display: true,
                    text: 'Number of Restaurants'
                  },
                  grid: { color: "rgba(0,0,0,0.1)" },
                  ticks: { color: "#4a5568" },
                },
                y1: {
                  type: 'linear',
                  display: true,
                  position: 'right',
                  beginAtZero: true,
                  max: 10,
                  title: {
                    display: true,
                    text: 'Foie Gras Rate (%)'
                  },
                  grid: { drawOnChartArea: false },
                  ticks: { 
                    color: "#2d5a4a",
                    callback: (v) => v + '%'
                  },
                },
                x: {
                  grid: { display: false },
                  ticks: { color: "#4a5568" },
                },
              },
            },
          });
        });

      // Foie gras price distribution chart
      fetch("/api/foie-price-dist")
        .then((res) => res.json())
        .then((dist) => {
          new Chart(document.getElementById("priceDistChart"), {
            type: "bar",
            data: {
              labels: ["Under $15", "$15 - $24", "$25 - $34", "$35+"],
              datasets: [{
                label: "Number of Items",
                data: [dist.under_15, dist["15_to_25"], dist["25_to_35"], dist["35_plus"]],
                backgroundColor: ["#9ca3af", "#c9a957", "#8b6b2a", "#2d5a4a"],
                borderRadius: 4,
              }],
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
              },
              scales: {
                y: { 
                  beginAtZero: true,
                  title: { display: true, text: 'Number of Menu Items' },
                  grid: { color: "rgba(0,0,0,0.1)" },
                  ticks: { color: "#4a5568" }
                },
                x: { grid: { display: false }, ticks: { color: "#4a5568" } },
              },
            },
          });
        });
        
      // Price tier prevalence (bar chart instead of pie)
      fetch("/api/price-tier-foie")
        .then((res) => res.json())
        .then((tiers) => {
          const tierOrder = ['$30 and under', '$31 to $50', '$50 and over'];
          const labels = tierOrder.filter(t => tiers[t]);
          const data = labels.map(l => tiers[l].rate);
          
          new Chart(document.getElementById("priceTierChart"), {
            type: "bar",
            data: {
              labels: labels,
              datasets: [{
                label: "% with Foie Gras",
                data: data,
                backgroundColor: ["#9ca3af", "#c9a957", "#2d5a4a"],
                borderRadius: 4,
              }],
            },
            options: {
              responsive: true,
              indexAxis: 'y',
              plugins: {
                legend: { display: false },
              },
              scales: {
                x: { 
                  beginAtZero: true,
                  max: 12,
                  title: { display: true, text: '% of Restaurants with Foie Gras' },
                  grid: { color: "#f0f0f0" },
                  ticks: { 
                    color: "#4a5568",
                    callback: (v) => v + "%"
                  }
                },
                y: { grid: { display: false }, ticks: { color: "#4a5568" } },
              },
            },
          });
        });
        
      // Cuisine breakdown - sorted descending
      fetch("/api/foie-cuisines")
        .then((res) => res.json())
        .then((cuisines) => {
          // Already sorted by data processor, take top 8
          const entries = Object.entries(cuisines).slice(0, 8);
          // Sort descending for display
          entries.sort((a, b) => b[1] - a[1]);
          
          new Chart(document.getElementById("cuisineChart"), {
            type: "bar",
            data: {
              labels: entries.map(e => e[0]),
              datasets: [{
                data: entries.map(e => e[1]),
                backgroundColor: "#c9a957",
                borderRadius: 4,
              }],
            },
            options: {
              responsive: true,
              indexAxis: 'y',
              plugins: {
                legend: { display: false },
              },
              scales: {
                x: { 
                  grid: { display: false }, 
                  ticks: { color: "#4a5568" },
                  title: { display: true, text: 'Number of Restaurants' }
                },
                y: { grid: { display: false }, ticks: { color: "#4a5568" } },
              },
            },
          });
        });
      
      // Menu section breakdown
      fetch("/api/foie-sections")
        .then((res) => res.json())
        .then((sections) => {
          const entries = Object.entries(sections).filter(e => e[1] > 0);
          entries.sort((a, b) => b[1] - a[1]);
          
          new Chart(document.getElementById("sectionChart"), {
            type: "bar",
            data: {
              labels: entries.map(e => e[0]),
              datasets: [{
                data: entries.map(e => e[1]),
                backgroundColor: ["#c9a957", "#3d7a6a", "#8b6b2a", "#9ca3af"],
                borderRadius: 4,
              }],
            },
            options: {
              responsive: true,
              indexAxis: 'y',
              plugins: {
                legend: { display: false },
              },
              scales: {
                x: { 
                  grid: { display: false }, 
                  ticks: { color: "#4a5568" },
                  title: { display: true, text: 'Number of Items' }
                },
                y: { grid: { display: false }, ticks: { color: "#4a5568" } },
              },
            },
          });
        });
    </script>
  </body>
</html>
